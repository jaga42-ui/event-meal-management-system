<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MealPass - UTSAH 2026</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; overflow: hidden; }
        .custom-bg { background: linear-gradient(133deg, #2A7B9B 0%, #57C785 50%, #2480D1 100%); }
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        .glass-dark { background: rgba(15, 17, 42, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animation Classes */
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .anim-pop { animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .anim-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>

<body class="h-screen flex flex-col custom-bg text-slate-800 selection:bg-teal-500 selection:text-white">

    <div id="authScreen" class="absolute inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/40 backdrop-blur-xl">
        <div class="w-full max-w-sm bg-white/90 p-8 rounded-[2.5rem] shadow-2xl text-center anim-pop">
            <div class="w-20 h-20 mx-auto bg-slate-100 rounded-3xl flex items-center justify-center mb-6 text-[#2A7B9B]"><i class="ph-duotone ph-qr-code text-4xl"></i></div>
            <h1 class="text-3xl font-extrabold mb-1">MealPass</h1>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-8">UTSAH 2026 Admin</p>
            <input id="loginEmail" type="email" class="w-full bg-slate-100 p-4 rounded-xl font-bold text-slate-700 mb-3 outline-none focus:ring-2 focus:ring-[#2A7B9B]" placeholder="admin@utsah.com">
            <input id="loginPassword" type="password" class="w-full bg-slate-100 p-4 rounded-xl font-bold text-slate-700 mb-6 outline-none focus:ring-2 focus:ring-[#2A7B9B]" placeholder="••••••">
            <button onclick="handleAuth()" class="w-full py-4 bg-slate-900 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">Authenticate</button>
        </div>
    </div>

    <div id="dashboard" class="hidden flex flex-col h-full w-full max-w-md mx-auto relative">
        
        <header class="flex justify-between items-center p-6 z-20">
            <div class="text-white">
                <h2 class="font-extrabold text-xl leading-none">MealPass</h2>
                <div id="roleBadge" class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">CONNECTING...</div>
            </div>
            <button onclick="toggleSearch()" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur border border-white/30 text-white flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                <i class="ph-bold ph-magnifying-glass text-lg"></i>
            </button>
        </header>

        <div id="searchOverlay" class="absolute top-0 left-0 right-0 p-4 z-30 hidden anim-slide-up bg-white/95 backdrop-blur-xl shadow-xl rounded-b-3xl">
            <div class="flex items-center gap-3">
                <i class="ph-bold ph-magnifying-glass text-slate-400 text-xl"></i>
                <input id="searchInput" oninput="handleSearch(this.value)" type="text" placeholder="Search Name or ID..." class="bg-transparent w-full text-slate-800 font-bold text-lg outline-none placeholder:text-slate-300">
                <button onclick="toggleSearch()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="searchResults" class="mt-4 max-h-48 overflow-y-auto hidden flex-col gap-2"></div>
        </div>

        <main class="flex-1 overflow-y-auto p-6 space-y-4 pb-24 no-scrollbar z-10">
            
            <div id="adminControls" class="hidden grid grid-cols-2 gap-3">
                 <button onclick="toggleMealDropdown()" class="col-span-2 glass p-3 rounded-2xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-orange-100 text-orange-500 flex items-center justify-center"><i class="ph-fill ph-clock text-xl"></i></div>
                        <div class="text-left">
                            <div class="text-[9px] uppercase font-bold text-slate-400">Current Session</div>
                            <div id="mealLabel" class="text-lg font-extrabold leading-none text-slate-800">Syncing...</div>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-down text-slate-400"></i>
                </button>
                <div id="mealDropdown" class="hidden col-span-2 glass p-2 rounded-2xl flex flex-col gap-1">
                    <button onclick="setMeal('Breakfast')" class="p-3 hover:bg-white/50 rounded-xl font-bold text-left">Breakfast</button>
                    <button onclick="setMeal('Lunch')" class="p-3 hover:bg-white/50 rounded-xl font-bold text-left">Lunch</button>
                    <button onclick="setMeal('Snacks')" class="p-3 hover:bg-white/50 rounded-xl font-bold text-left">Snacks</button>
                    <button onclick="setMeal('Dinner')" class="p-3 hover:bg-white/50 rounded-xl font-bold text-left">Dinner</button>
                </div>

                <div class="glass p-3 rounded-2xl">
                    <div class="text-[9px] uppercase font-bold text-slate-400">Served Today</div>
                    <div id="admSessionCount" class="text-2xl font-extrabold text-slate-800">0</div>
                </div>
                <div class="glass p-3 rounded-2xl">
                    <div class="text-[9px] uppercase font-bold text-slate-400">Total Database</div>
                    <div id="admDbCount" class="text-2xl font-extrabold text-slate-800">0</div>
                </div>
            </div>

            <div id="scannerArea" class="hidden">
                <div class="relative w-full aspect-square bg-black rounded-[2.5rem] overflow-hidden shadow-2xl border-4 border-white/40">
                    <div id="reader" class="w-full h-full opacity-80"></div>
                    <div id="startOverlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/60 backdrop-blur-md z-10">
                        <button onclick="startScanner()" class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(255,255,255,0.4)] animate-pulse">
                            <i class="ph-fill ph-camera text-3xl text-[#2480D1]"></i>
                        </button>
                        <p class="mt-4 text-xs font-bold text-white uppercase tracking-widest">Tap to Scan</p>
                    </div>
                </div>
                <button onclick="stopScanner()" id="stopBtn" class="hidden w-full mt-4 py-3 bg-red-100 text-red-600 font-bold rounded-xl">Stop Camera</button>
            </div>

        </main>

        <div id="offlineBadge" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-amber-100 border border-amber-200 text-amber-800 px-4 py-2 rounded-full items-center gap-2 shadow-xl z-50">
            <i class="ph-fill ph-wifi-slash"></i>
            <span class="text-xs font-bold uppercase"><span id="queueCount">0</span> Pending</span>
        </div>
    </div>

    <div id="registerModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-md p-6">
        <div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl anim-pop">
            <div class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mb-4"><i class="ph-bold ph-cardholder text-xl"></i></div>
            <h3 class="text-xl font-extrabold text-slate-800">Assign Card?</h3>
            <p class="text-xs text-slate-500 font-medium mb-4">This ID is not in the system. Assign it to a late arrival?</p>
            
            <div class="bg-slate-100 p-3 rounded-xl mb-4 font-mono text-xs font-bold text-center text-slate-500 border border-slate-200" id="regIdDisplay">ID: ---</div>
            
            <div class="space-y-3">
                <input id="regName" type="text" placeholder="Full Name" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl font-bold outline-none">
                <select id="regCat" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl font-bold outline-none text-slate-600">
                    <option value="Participant">Participant</option>
                    <option value="Team Manager">Team Manager</option>
                    <option value="DSW">DSW (VIP)</option>
                    <option value="Student Accompanist">Student Accompanist</option>
                    <option value="Professional Accompanist">Prof. Accompanist (VIP)</option>
                    <option value="Volunteer">Volunteer</option>
                </select>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="document.getElementById('registerModal').classList.add('hidden'); if(scanner) scanner.resume();" class="flex-1 py-3 text-slate-400 font-bold">Cancel</button>
                <button onclick="completeRegistration()" class="flex-1 py-3 bg-purple-600 text-white rounded-xl font-bold shadow-lg">Assign</button>
            </div>
        </div>
    </div>

    <div id="resultModal" class="hidden fixed inset-0 z-[90] flex items-center justify-center bg-slate-900/60 backdrop-blur-md transition-opacity">
        <div id="resultCard" class="bg-white w-80 rounded-[2.5rem] overflow-hidden shadow-2xl border-4 border-white transform transition-all p-6 text-center">
            </div>
    </div>

<script>
    /* === CONFIG & INIT === */
    const firebaseConfig = { apiKey: "AIzaSyDlgdYJ9-3ELhEjLz8EQJQK18ghlWhR-jo", authDomain: "orc-meal-tracker.firebaseapp.com", projectId: "orc-meal-tracker" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    db.enablePersistence().catch(e => console.log("Persistence", e));

    let currentMeal = "Breakfast";
    let scanner = null;
    let localCache = [];
    let offlineQueue = JSON.parse(localStorage.getItem('queue') || "[]");
    let tempScanId = ""; // Holds ID for registration

    /* === UTILS === */
    const getToday = () => new Date().toLocaleDateString('en-CA');
    const speak = (txt) => { if('speechSynthesis' in window){ let u = new SpeechSynthesisUtterance(txt); u.rate=1.1; window.speechSynthesis.speak(u); }};
    const toast = (msg) => { /* Simplified toast logic */ alert(msg); }; 

    /* === AUTH === */
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            initApp(u.uid);
        } else {
            document.getElementById('authScreen').classList.remove('hidden');
        }
    });

    async function handleAuth() {
        const e = document.getElementById('loginEmail').value;
        const p = document.getElementById('loginPassword').value;
        try { await auth.signInWithEmailAndPassword(e, p); } catch(err) { alert("Login Failed: " + err.message); }
    }

    async function initApp(uid) {
        const doc = await db.collection('users').doc(uid).get();
        const role = doc.exists ? doc.data().role : 'volunteer';
        document.getElementById('roleBadge').innerText = role.toUpperCase();
        
        document.getElementById('scannerArea').classList.remove('hidden');
        
        if(role === 'admin') {
            document.getElementById('adminControls').classList.remove('hidden');
            db.collection('settings').doc('global').onSnapshot(s => { if(s.exists) updateMealUI(s.data().currentMeal); });
            db.collection('allowed_ids').onSnapshot(s => document.getElementById('admDbCount').innerText = s.size);
        }

        db.collection('stats').doc('counts').onSnapshot(s => {
            if(s.exists) document.getElementById('admSessionCount').innerText = s.data()[`${currentMeal}_${getToday()}`] || 0;
        });
        
        // Cache for search & offline
        const snap = await db.collection('allowed_ids').get();
        localCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
        
        updateQueueUI();
    }

    /* === CORE LOGIC === */
    function updateMealUI(m) {
        currentMeal = m;
        document.getElementById('mealLabel').innerText = m;
    }
    
    function setMeal(m) {
        db.collection('settings').doc('global').set({currentMeal: m}, {merge:true});
        document.getElementById('mealDropdown').classList.add('hidden');
    }

    function toggleMealDropdown() { document.getElementById('mealDropdown').classList.toggle('hidden'); }

    /* === SCANNER === */
    async function startScanner() {
        if(scanner) return;
        document.getElementById('startOverlay').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScan);
    }

    function stopScanner() {
        if(scanner) { scanner.stop().then(() => scanner.clear()); scanner = null; }
        document.getElementById('startOverlay').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
    }

    async function onScan(txt) {
        const id = txt.trim().toUpperCase();
        if(scanner) scanner.pause();

        // 1. Search Local Cache First
        let user = localCache.find(u => u.id === id);

        // 2. If not found, try Network (if online)
        if(!user && navigator.onLine) {
            try {
                const doc = await db.collection('allowed_ids').doc(id).get();
                if(doc.exists) user = doc.data();
            } catch(e) {}
        }

        // 3. UNKNOWN ID -> REGISTRATION FLOW
        if(!user) {
            // Trigger Registration Modal
            tempScanId = id;
            document.getElementById('regIdDisplay').innerText = `ID: ${id}`;
            document.getElementById('registerModal').classList.remove('hidden');
            return;
        }

        // 4. CHECK MEAL STATUS
        const recordKey = `${currentMeal}_${getToday()}`;
        const ref = db.collection('meal_records').doc(id);
        
        try {
            const doc = await ref.get();
            if(doc.exists && doc.data().meals && doc.data().meals[recordKey]) {
                showResult(false, user, "Already Served", doc.data().meals[recordKey].time);
            } else {
                // WRITE (Robust)
                const payload = { id, meal: currentMeal, date: getToday(), time: new Date().toLocaleTimeString() };
                if(navigator.onLine) {
                    const batch = db.batch();
                    batch.set(ref, { meals: { [recordKey]: payload } }, { merge: true });
                    batch.set(db.collection('stats').doc('counts'), { [recordKey]: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                    batch.commit();
                } else {
                    offlineQueue.push(payload);
                    localStorage.setItem('queue', JSON.stringify(offlineQueue));
                    updateQueueUI();
                }
                showResult(true, user, "Authorized");
            }
        } catch(e) {
            alert(e);
            if(scanner) scanner.resume();
        }
    }

    /* === REGISTRATION LOGIC === */
    async function completeRegistration() {
        const name = document.getElementById('regName').value;
        const cat = document.getElementById('regCat').value;
        if(!name) return alert("Name required");

        const newUser = { name, category: cat, department: 'On-Spot', active: true };
        
        // Save to DB
        await db.collection('allowed_ids').doc(tempScanId).set(newUser);
        // Add to local cache instantly
        localCache.push({ id: tempScanId, ...newUser });
        
        document.getElementById('registerModal').classList.add('hidden');
        
        // Auto-process the meal
        onScan(tempScanId); 
    }

    /* === UI & THEMES === */
    function showResult(success, user, title, timeStr = "") {
        const modal = document.getElementById('resultModal');
        const card = document.getElementById('resultCard');
        
        // Determine Theme based on Category
        let theme = { bg: 'bg-green-500', text: 'text-green-600', icon: 'ph-check-circle', border: 'border-green-500' };
        
        if (!success) {
            theme = { bg: 'bg-red-500', text: 'text-red-600', icon: 'ph-warning-circle', border: 'border-red-500' };
            speak("Stop. Already Served.");
        } else {
            const cat = (user.category || "").toLowerCase();
            if (cat.includes('dsw') || cat.includes('professional')) {
                theme = { bg: 'bg-yellow-500', text: 'text-yellow-600', icon: 'ph-crown', border: 'border-yellow-500' }; // VIP Gold
                speak("Welcome VIP.");
            } else if (cat.includes('manager')) {
                theme = { bg: 'bg-purple-500', text: 'text-purple-600', icon: 'ph-briefcase', border: 'border-purple-500' }; // Manager Purple
                speak("Team Manager.");
            } else if (cat.includes('volunteer')) {
                theme = { bg: 'bg-blue-500', text: 'text-blue-600', icon: 'ph-hand-heart', border: 'border-blue-500' }; // Volunteer Blue
                speak("Volunteer.");
            } else {
                speak("Access Granted.");
            }
        }

        card.className = `bg-white w-80 rounded-[2.5rem] overflow-hidden shadow-2xl border-4 ${theme.border} transform transition-all p-0 text-center`;
        
        card.innerHTML = `
            <div class="${theme.bg} p-6 flex justify-center items-center">
                <i class="ph-fill ${theme.icon} text-5xl text-white"></i>
            </div>
            <div class="p-6">
                <h2 class="text-2xl font-extrabold ${theme.text}">${title}</h2>
                ${timeStr ? `<p class="text-xs font-bold text-slate-400 mt-1">Time: ${timeStr}</p>` : ''}
                
                <div class="my-4 border-t border-slate-100 pt-4">
                    <p class="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Name</p>
                    <p class="text-xl font-bold text-slate-800 leading-tight">${user.name}</p>
                </div>
                
                <div class="flex gap-2 justify-center">
                    <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 border border-slate-200">${user.category || 'Guest'}</span>
                </div>

                <button onclick="closeResult()" class="mt-6 w-full py-3 bg-slate-900 text-white font-bold rounded-xl shadow-lg">Scan Next</button>
            </div>
        `;

        modal.classList.remove('hidden');
    }

    function closeResult() {
        document.getElementById('resultModal').classList.add('hidden');
        if(scanner) scanner.resume();
    }

    /* === SEARCH UI === */
    function toggleSearch() {
        const el = document.getElementById('searchOverlay');
        el.classList.toggle('hidden');
        if(!el.classList.contains('hidden')) document.getElementById('searchInput').focus();
    }

    function handleSearch(q) {
        const div = document.getElementById('searchResults');
        if(q.length < 2) { div.classList.add('hidden'); return; }
        
        div.innerHTML = "";
        div.classList.remove('hidden');
        div.classList.add('flex');

        const matches = localCache.filter(u => u.name.toLowerCase().includes(q.toLowerCase()) || u.id.toLowerCase().includes(q.toLowerCase())).slice(0, 5);
        
        matches.forEach(u => {
            div.innerHTML += `
                <div onclick="manualProcess('${u.id}')" class="p-3 bg-slate-50 rounded-xl flex justify-between items-center cursor-pointer hover:bg-slate-100">
                    <div>
                        <div class="font-bold text-sm text-slate-800">${u.name}</div>
                        <div class="text-[10px] text-slate-500">${u.category}</div>
                    </div>
                    <i class="ph-bold ph-arrow-right text-slate-400"></i>
                </div>
            `;
        });
    }

    function manualProcess(id) {
        toggleSearch();
        onScan(id);
    }

    /* === OFFLINE SYNC === */
    function updateQueueUI() {
        const el = document.getElementById('offlineBadge');
        if(offlineQueue.length > 0) {
            el.classList.remove('hidden');
            el.classList.add('flex');
            document.getElementById('queueCount').innerText = offlineQueue.length;
        } else {
            el.classList.add('hidden');
            el.classList.remove('flex');
        }
    }

    setInterval(() => {
        if(navigator.onLine && offlineQueue.length > 0) {
            const batch = db.batch();
            const q = [...offlineQueue];
            q.forEach(item => {
                const k = `${item.meal}_${item.date}`;
                batch.set(db.collection('meal_records').doc(item.id), { meals: { [k]: item } }, {merge:true});
            });
            batch.commit().then(() => {
                offlineQueue = [];
                localStorage.setItem('queue', "[]");
                updateQueueUI();
            });
        }
    }, 5000);

</script>
</body>
</html>
